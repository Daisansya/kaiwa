<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>相談チャット</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    #roleSelect, #chatArea {
      background: white;
      padding: 15px;
      border-radius: 8px;
      max-width: 500px;
      margin: auto;
    }

    #chatArea {
      display: none;
    }

    .status {
      margin-top: 10px;
      font-weight: bold;
    }

    .message {
      margin: 5px 0;
    }

    .counselor {
      color: blue;
    }

    .client {
      color: green;
    }
  </style>
</head>
<body>

  <!-- 役割選択画面 -->
  <div id="roleSelect">
    <h2>相談チャット</h2>
    <input id="nameInput" type="text" placeholder="名前（任意）" />
    <br /><br />
    <button onclick="selectRole('counselor')">相談員</button>
    <button onclick="selectRole('client')">相談者</button>
    <div class="status" id="status">役割を選択してください</div>
  </div>

  <!-- チャット画面 -->
  <div id="chatArea">
    <div class="status" id="chatStatus"></div>
    <div id="messages"></div>
    <br />
    <button onclick="disconnectChat()">切断</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const roleSelect = document.getElementById("roleSelect");
    const chatArea = document.getElementById("chatArea");
    const status = document.getElementById("status");
    const chatStatus = document.getElementById("chatStatus");
    const messages = document.getElementById("messages");

    let myRole = null;
    let myName = null;

    function selectRole(role) {
      const nameInput = document.getElementById("nameInput");
      myName = nameInput.value || "匿名";
      myRole = role;

      socket.emit("selectRole", {
        role: role,
        name: myName
      });

      status.textContent = "待機中です…";
    }

    socket.on("waiting", () => {
      status.textContent = "待機中です…";
    });

    socket.on("matched", ({ partnerRole, partnerName }) => {
      roleSelect.style.display = "none";
      chatArea.style.display = "block";

      chatStatus.textContent =
        `${partnerRole}「${partnerName}」と接続しました`;

      messages.innerHTML = "";
    });

    function disconnectChat() {
      socket.emit("disconnectChat");

      chatArea.style.display = "none";
      roleSelect.style.display = "block";

      status.textContent = "役割を選択してください";
      chatStatus.textContent = "";
      messages.innerHTML = "";
    }

    socket.on("reset", () => {
      chatArea.style.display = "none";
      roleSelect.style.display = "block";
      status.textContent = "役割を選択してください";
    });
  </script>
</body>
</html>
